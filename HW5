import psycopg2


def create_db(conn):
    with conn.cursor() as cur:
        cur.execute("""
                CREATE TABLE IF NOT EXISTS client(
                    id SERIAL PRIMARY KEY,
                    name VARCHAR(40),
                    surname VARCHAR(40),
                    email VARCHAR(20)
                );
                """)
        cur.execute("""
                CREATE TABLE IF NOT EXISTS phone(
                    id SERIAL PRIMARY KEY,
                    phone_number VARCHAR(20) UNIQUE,
                    client_id INTEGER NOT NULL REFERENCES client(id) ON DELETE CASCADE
                );
                """)
        conn.commit()

def add_client(conn, name, surname, email, phones = None):
    with conn.cursor() as cur:
        cur.execute("""
                INSERT INTO client(name, surname, email) VALUES (%s, %s, %s)
                RETURNING id;
                """, (name, surname, email))
        
        client_id = cur.fetchone()[0]

        if phones:
            for phone in phones:
                cur.execute("""
                        INSERT INTO phone(phone_number, client_id) VALUES (%s, %s)
                        ON CONFLICT (phone_number) DO NOTHING;    
                        """, (phone, client_id))
            conn.commit()

        cur.execute("""
                SELECT * FROM client;
                """)
        
        print(cur.fetchall())

def add_phone(conn, number, client_id):
    with conn.cursor() as cur:
        cur.execute("""SELECT id FROM client
                    WHERE id = %s;""", (client_id,))
        if not cur.fetchone():
            print(f"Клиента с {client_id} не найдено")
            return
        
        cur.execute("""
                INSERT INTO phone(phone_number, client_id) VALUES (%s, %s)
                ON CONFLICT (phone_number) DO NOTHING;
                """, (number, client_id))
        conn.commit()
        
        cur.execute("""
                SELECT * FROM phone;
                """)
        print(cur.fetchall())

def change_client(conn, client_id, name = None, surname = None, email = None, phones = None):
    with conn.cursor() as cur:
        cur.execute("""SELECT id FROM client
                    WHERE id = %s;""", (client_id,))
        if not cur.fetchone():
            print(f"Клиента с {client_id} не найдено")
            return
        fields = []
        params = []
        if name:
            fields.append("name = %s")
            params.append(name)
        if surname:
            fields.append("surname = %s")
            params.append(surname)
        if email:
            fields.append("email = %s")
            params.append(email)

        if fields:
            params.append(client_id)
            q = f"""
            UPDATE client
            SET {",".join(fields)}
            WHERE id = %s
            """
            cur.execute(q, params)

        if phones:
            cur.execute("DELETE FROM phone WHERE client_id = %s", (client_id,))
            for phone in phones:
                cur.execute("""
                INSERT INTO phone (phone_number, client_id)
                VALUES (%s, %s)
                ON CONFLICT (phone_number) DO NOTHING
                """, (phone, client_id))
        conn.commit()

def delete_phone(conn, client_id, phone):
    with conn.cursor() as cur:
        cur.execute("""SELECT id FROM client
                    WHERE id = %s;""", (client_id,))
        if not cur.fetchone():
            print(f"Клиента с {client_id} не найдено")
            return
        
        cur.execute("DELETE FROM phone WHERE client_id = %s AND phone_number = %s", (client_id, phone))
        
        conn.commit()

def delete_client(conn, client_id):
    with conn.cursor() as cur:
        cur.execute("""SELECT id FROM client
                    WHERE id = %s;""", (client_id,))
        if not cur.fetchone():
            print(f"Клиента с {client_id} не найдено")
            return
        
        cur.execute("DELETE FROM client WHERE id = %s", (client_id,))
        
        conn.commit()

def find_client(conn, name=None, surname=None, email=None, phone=None):
    with conn.cursor() as cur:
        if phone:
            cur.execute("""
                SELECT c.*, p.phone_number 
                FROM client c
                LEFT JOIN phone p ON c.id = p.client_id
                WHERE p.phone_number = %s
            """, (phone,))
        else:
            conditions = []
            params = []
            if name:
                conditions.append("name = %s")
                params.append(name)
            if surname:
                conditions.append("surname = %s")
                params.append(surname)
            if email:
                conditions.append("email = %s")
                params.append(email)
            
            where_clause = " AND ".join(conditions) if conditions else "TRUE"
            query = f"""
                SELECT c.*, p.phone_number 
                FROM client c
                LEFT JOIN phone p ON c.id = p.client_id
                WHERE {where_clause}
            """
            cur.execute(query, params)
        
        results = cur.fetchall()
        return results
